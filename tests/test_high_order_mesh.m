clearvars -except Files Passed CPUTime Test;

%% Input

% Simulation ---------------------------------------------------------------------------------------
Simulation.Type='ConvergenceSpace';              % Simulation type
Simulation.Problem='Magnetic';                   % Problem
% --------------------------------------------------------------------------------------------------

% Parameters ---------------------------------------------------------------------------------------
Parameters.Formulation='MagneticCURLCURL_HDG';   % Formulation
Parameters.Problem='Magnetic';                   % Problem
Parameters.PostProcessingHDG='yes';              % Perform HDG postprocessing
Parameters.ConvectiveTerm='yes';                 % Convective term
Parameters.Degree=2;                             % Degree
Parameters.StabMagneticInduction=1;              % Stabilization for magnetic induction
Parameters.StabLagrangeMultiplier=1;             % Stabilization for Lagrange multiplier
Parameters.ReferenceDensity=1;                   % Reference density
Parameters.ReferencePressure=0;                  % Reference pressure
Parameters.CompressibilityCoeff=1/10;            % Compressibility coefficient
Parameters.DynamicViscosity=1;                   % Dynamic viscosity
Parameters.MagneticDiffusivity=1;                % Magnetic diffusivity
Parameters.MagneticPermeability=1;               % Magnetic permeability
Parameters.InnerRadius=1;                        % Inner radius
Parameters.OuterRadius=2;                        % Outer radius
Parameters.InnerAngularVelocity=0;               % Inner wall angular velocity
Parameters.OuterAngularVelocity=1/2;             % Outer wall angular velocity
Parameters.Hartmann=1;                           % Hartmann number
mu=Parameters.DynamicViscosity;
eta=Parameters.MagneticDiffusivity; mu_m=Parameters.MagneticPermeability;
r1=Parameters.InnerRadius;          r2=Parameters.OuterRadius;
w1=Parameters.InnerAngularVelocity; w2=Parameters.OuterAngularVelocity;
Ha=Parameters.Hartmann;
Parameters.ScaledMagneticCurl=...                % Scaled magnetic curl
  @(x,y,z,t) (Ha.*mu.^(1./2).*mu_m.^(1./2).*r1.*r2.^((Ha.^2+1).^(1./2)+1).*(w1-w2).*(r1.^((Ha.^2+1).^(1./2)).*r2.^((Ha.^2+1).^(1./2)+1)+r1.*(x.^2+y.^2).^((Ha.^2+1).^(1./2))+r1.^(2.*(Ha.^2+1).^(1./2)+1).*(Ha.^2+1).^(1./2)-r1.^(2.*(Ha.^2+1).^(1./2)+1)+r1.*(Ha.^2+1).^(1./2).*(x.^2+y.^2).^((Ha.^2+1).^(1./2))-r1.^((Ha.^2+1).^(1./2)).*r2.^(1-(Ha.^2+1).^(1./2)).*(x.^2+y.^2).^((Ha.^2+1).^(1./2))-r1.^((Ha.^2+1).^(1./2)).*r2.^((Ha.^2+1).^(1./2)+1).*(Ha.^2+1).^(1./2)-r1.^((Ha.^2+1).^(1./2)).*r2.^(1-(Ha.^2+1).^(1./2)).*(Ha.^2+1).^(1./2).*(x.^2+y.^2).^((Ha.^2+1).^(1./2))))./((x.^2+y.^2).^((Ha.^2+1).^(1./2)./2+1./2).*(r1.^(2.*(Ha.^2+1).^(1./2)).*r2.^2-r1.^(2.*(Ha.^2+1).^(1./2)).*r1.^2+r1.^2.*r2.^(2.*(Ha.^2+1).^(1./2))-r2.^(2.*(Ha.^2+1).^(1./2)).*r2.^2+r1.^(2.*(Ha.^2+1).^(1./2)).*r1.^2.*(Ha.^2+1).^(1./2)+r1.^(2.*(Ha.^2+1).^(1./2)).*r2.^2.*(Ha.^2+1).^(1./2)+r1.^2.*r2.^(2.*(Ha.^2+1).^(1./2)).*(Ha.^2+1).^(1./2)+r2.^(2.*(Ha.^2+1).^(1./2)).*r2.^2.*(Ha.^2+1).^(1./2)-4.*r1.*r1.^((Ha.^2+1).^(1./2)).*r2.*r2.^((Ha.^2+1).^(1./2)).*(Ha.^2+1).^(1./2)));
Parameters.MagneticInduction=...                 % Magnetic induction
  @(x,y,z,t) [(Ha.*x.*(eta.*mu.*mu_m).^(1./2))./(x.^2+y.^2)-(Ha.*r1.*r2.^(1-(Ha.^2+1).^(1./2)).*y.*(w1-w2).*((mu.*mu_m)./eta).^(1./2).*(r1.*(x.^2+y.^2).^((Ha.^2+1).^(1./2)+1./2)-r2.*(x.^2+y.^2).^((Ha.^2+1).^(1./2)+1./2).*(r1./r2).^((Ha.^2+1).^(1./2))-r1.*r2.^((Ha.^2+1).^(1./2)+1).*(x.^2+y.^2).^((Ha.^2+1).^(1./2)./2)+r2.*r2.^(2.*(Ha.^2+1).^(1./2)).*(x.^2+y.^2).^(1./2).*(r1./r2).^((Ha.^2+1).^(1./2))+r1.*r2.^((Ha.^2+1).^(1./2)+1).*(x.^2+y.^2).^((Ha.^2+1).^(1./2)./2).*(r1./r2).^(2.*(Ha.^2+1).^(1./2))-r1.*r2.^(2.*(Ha.^2+1).^(1./2)).*(x.^2+y.^2).^(1./2).*(r1./r2).^(2.*(Ha.^2+1).^(1./2))))./((x.^2+y.^2).^((Ha.^2+1).^(1./2)./2+1).*(r1.^2.*(Ha.^2+1).^(1./2)+r2.^2.*(Ha.^2+1).^(1./2)+r1.^2-r2.^2-r1.^2.*(r1./r2).^(2.*(Ha.^2+1).^(1./2))+r2.^2.*(r1./r2).^(2.*(Ha.^2+1).^(1./2))+r1.^2.*(Ha.^2+1).^(1./2).*(r1./r2).^(2.*(Ha.^2+1).^(1./2))+r2.^2.*(Ha.^2+1).^(1./2).*(r1./r2).^(2.*(Ha.^2+1).^(1./2))-4.*r1.*r2.*(Ha.^2+1).^(1./2).*(r1./r2).^((Ha.^2+1).^(1./2)))),...
              (Ha.*y.*(eta.*mu.*mu_m).^(1./2))./(x.^2+y.^2)+(Ha.*r1.*r2.^(1-(Ha.^2+1).^(1./2)).*x.*(w1-w2).*((mu.*mu_m)./eta).^(1./2).*(r1.*(x.^2+y.^2).^((Ha.^2+1).^(1./2)+1./2)-r2.*(x.^2+y.^2).^((Ha.^2+1).^(1./2)+1./2).*(r1./r2).^((Ha.^2+1).^(1./2))-r1.*r2.^((Ha.^2+1).^(1./2)+1).*(x.^2+y.^2).^((Ha.^2+1).^(1./2)./2)+r2.*r2.^(2.*(Ha.^2+1).^(1./2)).*(x.^2+y.^2).^(1./2).*(r1./r2).^((Ha.^2+1).^(1./2))+r1.*r2.^((Ha.^2+1).^(1./2)+1).*(x.^2+y.^2).^((Ha.^2+1).^(1./2)./2).*(r1./r2).^(2.*(Ha.^2+1).^(1./2))-r1.*r2.^(2.*(Ha.^2+1).^(1./2)).*(x.^2+y.^2).^(1./2).*(r1./r2).^(2.*(Ha.^2+1).^(1./2))))./((x.^2+y.^2).^((Ha.^2+1).^(1./2)./2+1).*(r1.^2.*(Ha.^2+1).^(1./2)+r2.^2.*(Ha.^2+1).^(1./2)+r1.^2-r2.^2-r1.^2.*(r1./r2).^(2.*(Ha.^2+1).^(1./2))+r2.^2.*(r1./r2).^(2.*(Ha.^2+1).^(1./2))+r1.^2.*(Ha.^2+1).^(1./2).*(r1./r2).^(2.*(Ha.^2+1).^(1./2))+r2.^2.*(Ha.^2+1).^(1./2).*(r1./r2).^(2.*(Ha.^2+1).^(1./2))-4.*r1.*r2.*(Ha.^2+1).^(1./2).*(r1./r2).^((Ha.^2+1).^(1./2))))];
Parameters.LagrangeMultiplier=@(x,y,z,t) 0*x;    % Lagrange multiplier
Parameters.TangentialElectricField=...           % Tangential electric field
  @(x,y,z,t) [sign(sqrt(x.^2+y.^2)-(r1+r2)/2).*(-(Ha.*eta.^(1./2).*mu.^(1./2).*mu_m.^(1./2).*y.*(w1.*r1.^2.*r2.^(2.*(Ha.^2+1).^(1./2))-w1.*r1.^(2.*(Ha.^2+1).^(1./2)).*r1.^2+w2.*r1.^(2.*(Ha.^2+1).^(1./2)).*r2.^2-w2.*r2.^(2.*(Ha.^2+1).^(1./2)).*r2.^2+w1.*r1.^(2.*(Ha.^2+1).^(1./2)).*r1.^2.*(Ha.^2+1).^(1./2)+w1.*r1.^2.*r2.^(2.*(Ha.^2+1).^(1./2)).*(Ha.^2+1).^(1./2)+w2.*r1.^(2.*(Ha.^2+1).^(1./2)).*r2.^2.*(Ha.^2+1).^(1./2)+w2.*r2.^(2.*(Ha.^2+1).^(1./2)).*r2.^2.*(Ha.^2+1).^(1./2)-2.*w1.*r1.*r1.^((Ha.^2+1).^(1./2)).*r2.*r2.^((Ha.^2+1).^(1./2)).*(Ha.^2+1).^(1./2)-2.*w2.*r1.*r1.^((Ha.^2+1).^(1./2)).*r2.*r2.^((Ha.^2+1).^(1./2)).*(Ha.^2+1).^(1./2)))./((x.^2+y.^2).^(1./2).*(r1.^(2.*(Ha.^2+1).^(1./2)).*r2.^2-r1.^(2.*(Ha.^2+1).^(1./2)).*r1.^2+r1.^2.*r2.^(2.*(Ha.^2+1).^(1./2))-r2.^(2.*(Ha.^2+1).^(1./2)).*r2.^2+r1.^(2.*(Ha.^2+1).^(1./2)).*r1.^2.*(Ha.^2+1).^(1./2)+r1.^(2.*(Ha.^2+1).^(1./2)).*r2.^2.*(Ha.^2+1).^(1./2)+r1.^2.*r2.^(2.*(Ha.^2+1).^(1./2)).*(Ha.^2+1).^(1./2)+r2.^(2.*(Ha.^2+1).^(1./2)).*r2.^2.*(Ha.^2+1).^(1./2)-4.*r1.*r1.^((Ha.^2+1).^(1./2)).*r2.*r2.^((Ha.^2+1).^(1./2)).*(Ha.^2+1).^(1./2)))),...
              sign(sqrt(x.^2+y.^2)-(r1+r2)/2).*(+(Ha.*eta.^(1./2).*mu.^(1./2).*mu_m.^(1./2).*x.*(w1.*r1.^2.*r2.^(2.*(Ha.^2+1).^(1./2))-w1.*r1.^(2.*(Ha.^2+1).^(1./2)).*r1.^2+w2.*r1.^(2.*(Ha.^2+1).^(1./2)).*r2.^2-w2.*r2.^(2.*(Ha.^2+1).^(1./2)).*r2.^2+w1.*r1.^(2.*(Ha.^2+1).^(1./2)).*r1.^2.*(Ha.^2+1).^(1./2)+w1.*r1.^2.*r2.^(2.*(Ha.^2+1).^(1./2)).*(Ha.^2+1).^(1./2)+w2.*r1.^(2.*(Ha.^2+1).^(1./2)).*r2.^2.*(Ha.^2+1).^(1./2)+w2.*r2.^(2.*(Ha.^2+1).^(1./2)).*r2.^2.*(Ha.^2+1).^(1./2)-2.*w1.*r1.*r1.^((Ha.^2+1).^(1./2)).*r2.*r2.^((Ha.^2+1).^(1./2)).*(Ha.^2+1).^(1./2)-2.*w2.*r1.*r1.^((Ha.^2+1).^(1./2)).*r2.*r2.^((Ha.^2+1).^(1./2)).*(Ha.^2+1).^(1./2)))./((x.^2+y.^2).^(1./2).*(r1.^(2.*(Ha.^2+1).^(1./2)).*r2.^2-r1.^(2.*(Ha.^2+1).^(1./2)).*r1.^2+r1.^2.*r2.^(2.*(Ha.^2+1).^(1./2))-r2.^(2.*(Ha.^2+1).^(1./2)).*r2.^2+r1.^(2.*(Ha.^2+1).^(1./2)).*r1.^2.*(Ha.^2+1).^(1./2)+r1.^(2.*(Ha.^2+1).^(1./2)).*r2.^2.*(Ha.^2+1).^(1./2)+r1.^2.*r2.^(2.*(Ha.^2+1).^(1./2)).*(Ha.^2+1).^(1./2)+r2.^(2.*(Ha.^2+1).^(1./2)).*r2.^2.*(Ha.^2+1).^(1./2)-4.*r1.*r1.^((Ha.^2+1).^(1./2)).*r2.*r2.^((Ha.^2+1).^(1./2)).*(Ha.^2+1).^(1./2))))];
Parameters.NormalMagneticInduction=...           % Normal magnetic induction
  @(x,y,z,t) sign(sqrt(x.^2+y.^2)-(r1+r2)/2).*(Ha.*eta.^(1./2).*mu.^(1./2).*mu_m.^(1./2))./(x.^2+y.^2).^(1./2);
Parameters.Source=@(x,y,z,t) [0*x,0*x];          % Source
Parameters.Velocity=...                          % Velocity
  @(x,y,z,t) [-(y.*((w2.*(x.^2+y.^2).^(1./2).*((Ha.*(1./(r1./r2).^((Ha.^2+1).^(1./2))-(w1.*r1)./(w2.*r2)).*(r2-r1.*(r1./r2).^((Ha.^2+1).^(1./2))))./(r2.*((Ha.^2+1).^(1./2)+1))+(Ha.*(w1.*r1-w2.*r2.*(r1./r2).^((Ha.^2+1).^(1./2))).*((r1./r2).^(1-(Ha.^2+1).^(1./2))-1))./(w2.*r2.*((Ha.^2+1).^(1./2)-1))))./((Ha.*(r1-r2.*(r1./r2).^((Ha.^2+1).^(1./2))).*((r1./r2).^(1-(Ha.^2+1).^(1./2))-1))./(r2.*((Ha.^2+1).^(1./2)-1))-(Ha.*(r2-r1.*(r1./r2).^((Ha.^2+1).^(1./2))).*(r1./r2-1./(r1./r2).^((Ha.^2+1).^(1./2))))./(r2.*((Ha.^2+1).^(1./2)+1)))+(Ha.*r1.*r2.^((Ha.^2+1).^(1./2)-1).*(r2-r1.*(r1./r2).^((Ha.^2+1).^(1./2))).*(w1-w2))./((x.^2+y.^2).^((Ha.^2+1).^(1./2)./2).*((Ha.*(r1-r2.*(r1./r2).^((Ha.^2+1).^(1./2))).*((r1./r2).^(1-(Ha.^2+1).^(1./2))-1))./(r2.*((Ha.^2+1).^(1./2)-1))-(Ha.*(r2-r1.*(r1./r2).^((Ha.^2+1).^(1./2))).*(r1./r2-1./(r1./r2).^((Ha.^2+1).^(1./2))))./(r2.*((Ha.^2+1).^(1./2)+1))).*((Ha.^2+1).^(1./2)+1))-(Ha.*r1.*(x.^2+y.^2).^((Ha.^2+1).^(1./2)./2).*((r1./r2).^(1-(Ha.^2+1).^(1./2))-1).*(w1-w2))./(r2.^((Ha.^2+1).^(1./2)).*((Ha.*(r1-r2.*(r1./r2).^((Ha.^2+1).^(1./2))).*((r1./r2).^(1-(Ha.^2+1).^(1./2))-1))./(r2.*((Ha.^2+1).^(1./2)-1))-(Ha.*(r2-r1.*(r1./r2).^((Ha.^2+1).^(1./2))).*(r1./r2-1./(r1./r2).^((Ha.^2+1).^(1./2))))./(r2.*((Ha.^2+1).^(1./2)+1))).*((Ha.^2+1).^(1./2)-1))))./(x.^2+y.^2).^(1./2),...
              +(x.*((w2.*(x.^2+y.^2).^(1./2).*((Ha.*(1./(r1./r2).^((Ha.^2+1).^(1./2))-(w1.*r1)./(w2.*r2)).*(r2-r1.*(r1./r2).^((Ha.^2+1).^(1./2))))./(r2.*((Ha.^2+1).^(1./2)+1))+(Ha.*(w1.*r1-w2.*r2.*(r1./r2).^((Ha.^2+1).^(1./2))).*((r1./r2).^(1-(Ha.^2+1).^(1./2))-1))./(w2.*r2.*((Ha.^2+1).^(1./2)-1))))./((Ha.*(r1-r2.*(r1./r2).^((Ha.^2+1).^(1./2))).*((r1./r2).^(1-(Ha.^2+1).^(1./2))-1))./(r2.*((Ha.^2+1).^(1./2)-1))-(Ha.*(r2-r1.*(r1./r2).^((Ha.^2+1).^(1./2))).*(r1./r2-1./(r1./r2).^((Ha.^2+1).^(1./2))))./(r2.*((Ha.^2+1).^(1./2)+1)))+(Ha.*r1.*r2.^((Ha.^2+1).^(1./2)-1).*(r2-r1.*(r1./r2).^((Ha.^2+1).^(1./2))).*(w1-w2))./((x.^2+y.^2).^((Ha.^2+1).^(1./2)./2).*((Ha.*(r1-r2.*(r1./r2).^((Ha.^2+1).^(1./2))).*((r1./r2).^(1-(Ha.^2+1).^(1./2))-1))./(r2.*((Ha.^2+1).^(1./2)-1))-(Ha.*(r2-r1.*(r1./r2).^((Ha.^2+1).^(1./2))).*(r1./r2-1./(r1./r2).^((Ha.^2+1).^(1./2))))./(r2.*((Ha.^2+1).^(1./2)+1))).*((Ha.^2+1).^(1./2)+1))-(Ha.*r1.*(x.^2+y.^2).^((Ha.^2+1).^(1./2)./2).*((r1./r2).^(1-(Ha.^2+1).^(1./2))-1).*(w1-w2))./(r2.^((Ha.^2+1).^(1./2)).*((Ha.*(r1-r2.*(r1./r2).^((Ha.^2+1).^(1./2))).*((r1./r2).^(1-(Ha.^2+1).^(1./2))-1))./(r2.*((Ha.^2+1).^(1./2)-1))-(Ha.*(r2-r1.*(r1./r2).^((Ha.^2+1).^(1./2))).*(r1./r2-1./(r1./r2).^((Ha.^2+1).^(1./2))))./(r2.*((Ha.^2+1).^(1./2)+1))).*((Ha.^2+1).^(1./2)-1))))./(x.^2+y.^2).^(1./2)];
clear mu eta mu_m r1 r2 w1 w2 Ha
% --------------------------------------------------------------------------------------------------

% Geometry and mesh --------------------------------------------------------------------------------
MeshFile=...                                     % Mesh file
  {'Mesh_taylorcouette_curved_opt2_k2_r2',...
   'Mesh_taylorcouette_curved_opt2_k2_r3'};
% --------------------------------------------------------------------------------------------------

% System -------------------------------------------------------------------------------------------
System.SymmetrizeMatrix='no';                    % Symmetrize matrix
System.Nonlinear='no';                           % Nonlinear
% --------------------------------------------------------------------------------------------------

% Time parameters ----------------------------------------------------------------------------------
Time.TimeDependent='no';                         % Time dependent problem
% --------------------------------------------------------------------------------------------------

% Solver -------------------------------------------------------------------------------------------
Solver.Type='backslash';                         % Type
% --------------------------------------------------------------------------------------------------

% Boundary splitting -------------------------------------------------------------------------------
Boundaries.Dirichlet=2;                          % Dirichlet portion
Boundaries.Natural=1;                            % Natural portion
% --------------------------------------------------------------------------------------------------

% Output options -----------------------------------------------------------------------------------
Options.PlotGeometry='no';                       % Plot geometry
Options.PlotMesh='no';                           % Plot mesh
Options.PlotConvergence='no';                    % Plot convergence
Options.CharacteristicElementSize='Min';         % Characteristic element size
Options.ComputeError=...                         % Compute error
  {'ScaledMagneticCurl'   ,'L2';
   'MagneticInduction'    ,'L2';
   'LagrangeMultiplier'   ,'L2';
   'MagneticInduction'    ,'Hcurl';
   'MagneticInductionPost','Hcurl'};
Options.Test=...                                 % Test
  ['abs(Results.ScaledMagneticCurlErrorL2Rate(end)      -(Parameters.Degree(end)+1))<2e-2 && ',...
   'abs(Results.MagneticInductionErrorL2Rate(end)       -(Parameters.Degree(end)+1))<6e-2 &&',...
   'abs(Results.LagrangeMultiplierErrorL2Rate(end)      -(Parameters.Degree(end)+1))<8e-2 &&',...
   'abs(Results.MagneticInductionErrorHcurlRate(end)    -(Parameters.Degree(end)+0))<3e-1 &&',...
   'abs(Results.MagneticInductionPostErrorHcurlRate(end)-(Parameters.Degree(end)+1))<2e-2'];
% --------------------------------------------------------------------------------------------------

%% Main

main